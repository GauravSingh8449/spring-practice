<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>User Documents</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</head>
<body class="bg-light">

<div class="container mt-5">
    <h2 class="mb-4">ðŸ“‚ Your Uploaded Documents</h2>

    <!-- Upload Form -->
    <form th:action="@{/documents/upload}" method="post" enctype="multipart/form-data" class="mb-4">
        <div class="input-group">
            <input type="file" name="file" class="form-control" required>
            <button class="btn btn-success" type="submit"><i class="bi bi-upload"></i> Upload</button>
        </div>
    </form>

    <!-- Documents Table -->
    <table class="table table-bordered bg-white shadow-sm">
        <thead class="table-dark">
            <tr>
                <th>#</th>
                <th>File Name</th>
                <th class="text-center">Actions</th>
            </tr>
        </thead>
        <tbody>
            <tr th:each="doc, iterStat : ${documents}" th:attr="data-id=${doc.id}">
                <td th:text="${iterStat.index + 1}"></td>
                <td th:text="${doc.fileName}"></td>
                <td class="text-center">
                    <!-- Download Icon -->
                    <a th:href="@{'/documents/download/' + ${doc.id}}" 
                       class="btn btn-outline-primary btn-sm me-1" 
                       title="Download">
                        <i class="bi bi-download"></i>
                    </a>

                    <!-- Preview Icon -->
                    <a th:href="@{'/documents/preview/' + ${doc.id}}" 
                       target="_blank" 
                       class="btn btn-outline-info btn-sm me-1" 
                       title="Preview">
                        <i class="bi bi-eye"></i>
                    </a>

                    <!-- Delete Icon (AJAX) -->
                    <button type="button" class="btn btn-outline-danger btn-sm" 
                            title="Delete"
                            th:onclick="'deleteDoc(' + ${doc.id} + ')'">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        </tbody>
    </table>

    <a th:href="@{/home}" class="btn btn-secondary mt-3">â¬… Back to Home</a>
</div>

<!-- Toast Container -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">

    <!-- Upload Success Toast -->
    <div id="uploadToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="uploadToastMessage">Document uploaded successfully!</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>

    <!-- Delete Success Toast -->
    <div id="deleteToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="deleteToastMessage">Document deleted successfully!</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>

</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Show Upload Toast if message exists -->
<script th:if="${successMessage}">
    const uploadToastEl = document.getElementById('uploadToast');
    const uploadToast = new bootstrap.Toast(uploadToastEl, { delay: 2000 });
    uploadToastEl.querySelector('#uploadToastMessage').innerText = /*[[${successMessage}]]*/ 'Document uploaded successfully!';
    uploadToast.show();
</script>

<!-- AJAX Delete Script with Toast -->
<script>
function deleteDoc(id) {
    if(!confirm('Are you sure you want to delete this document?')) return;

    fetch('/documents/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'id=' + id
    })
    .then(res => res.json())
    .then(data => {
        if(data.status === 'success') {
            const row = document.querySelector('tr[data-id="'+id+'"]');
            if(row) row.remove();

            // Show delete toast
            const toastEl = document.getElementById('deleteToast');
            toastEl.querySelector('#deleteToastMessage').innerText = data.message;
            const toast = new bootstrap.Toast(toastEl, { delay: 2000 });
            toast.show();
        } else {
            alert(data.message);
        }
    })
    .catch(err => {
        console.error(err);
        alert('Something went wrong!');
    });
}
</script>

</body>
</html>
