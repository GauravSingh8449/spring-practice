<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>User Documents</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        body { 
            background: #f0f4f8; 
            font-family: 'Poppins', sans-serif; 
        }

        h2 { 
            text-align: center; 
            margin-bottom: 25px; 
            color: #333; 
            font-weight: 600; 
        }

        /* Upload Form */
        .input-group input { 
            padding: 12px; 
            font-size: 1rem; 
        }
        .input-group button { 
            font-size: 1rem; 
            padding: 10px; 
            background: linear-gradient(135deg, #00c6ff, #0072ff);
            border: none;
            color: #fff;
        }
        .input-group button:hover {
            opacity: 0.9;
        }

        /* Mobile Cards */
        .doc-card .card { 
            border-radius: 15px; 
            background: linear-gradient(145deg, #ffffff, #e6f0fa);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .doc-card .card:hover { 
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.25);
        }
        .doc-card .card-body { 
            padding: 1.2rem; 
        }
        .doc-card .btn { 
            font-size: 1rem; 
            padding: 0.9rem; 
            border-radius: 10px; 
        }

        /* Table adjustments for tablet/desktop */
        table th, table td { 
            vertical-align: middle; 
            font-size: 0.95rem; 
        }
        table .btn { 
            font-size: 0.9rem; 
            padding: 0.4rem 0.6rem; 
            border-radius: 8px;
        }

        /* Toasts */
        .toast-container { 
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            z-index: 9999; 
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            h2 { font-size: 1.6rem; }
            .input-group input, .input-group button { font-size: 1.05rem; }
            .doc-card .btn { font-size: 1.05rem; padding: 1rem; }
        }

        @media (max-width: 576px) {
            h2 { font-size: 1.5rem; }
            .input-group input, .input-group button { font-size: 1.1rem; padding: 12px; }
            .doc-card .btn { font-size: 1.1rem; padding: 1.1rem; }
            table th, table td { font-size: 1rem; }
        }
    </style>
</head>
<body>

<div class="container mt-5">
    <h2>ðŸ“‚ Your Uploaded Documents</h2>

    <!-- Upload Form -->
    <form th:action="@{/documents/upload}" method="post" enctype="multipart/form-data" class="mb-4">
        <div class="input-group">
            <input type="file" name="file" class="form-control" required>
            <button class="btn" type="submit"><i class="bi bi-upload"></i> Upload</button>
        </div>
    </form>

    <!-- Mobile Cards -->
    <div class="d-block d-md-none">
        <div class="doc-card" th:each="doc, iterStat : ${documents}" th:attr="data-id=${doc.id}">
            <div class="card shadow-sm mb-3">
                <div class="card-body">
                    <h5 class="card-title" th:text="${iterStat.index + 1} + '. ' + ${doc.fileName}"></h5>
                    <div class="d-flex flex-column gap-2 mt-3">
                        <a th:href="@{'/documents/download/' + ${doc.id}}" class="btn btn-outline-primary btn-lg w-100"><i class="bi bi-download"></i> Download</a>
                        <a th:href="@{'/documents/preview/' + ${doc.id}}" target="_blank" class="btn btn-outline-info btn-lg w-100"><i class="bi bi-eye"></i> Preview</a>
                        <button type="button" class="btn btn-outline-danger btn-lg w-100" th:onclick="'deleteDoc(' + ${doc.id} + ')'"><i class="bi bi-trash"></i> Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Desktop/Tablet Table -->
    <div class="table-responsive d-none d-md-block">
        <table class="table table-bordered bg-white shadow-sm">
            <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th>File Name</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="doc, iterStat : ${documents}" th:attr="data-id=${doc.id}">
                    <td th:text="${iterStat.index + 1}"></td>
                    <td th:text="${doc.fileName}"></td>
                    <td class="text-center">
                        <a th:href="@{'/documents/download/' + ${doc.id}}" class="btn btn-outline-primary btn-sm me-1"><i class="bi bi-download"></i></a>
                        <a th:href="@{'/documents/preview/' + ${doc.id}}" target="_blank" class="btn btn-outline-info btn-sm me-1"><i class="bi bi-eye"></i></a>
                        <button type="button" class="btn btn-outline-danger btn-sm" th:onclick="'deleteDoc(' + ${doc.id} + ')'"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <a th:href="@{/home}" class="btn btn-secondary mt-3 d-block d-md-inline-block">â¬… Back to Home</a>
</div>

<!-- Toast Container -->
<div class="toast-container">
    <div id="uploadToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="uploadToastMessage">Document uploaded successfully!</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>

    <div id="deleteToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="deleteToastMessage">Document deleted successfully!</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script th:if="${successMessage}">
    const uploadToastEl = document.getElementById('uploadToast');
    const uploadToast = new bootstrap.Toast(uploadToastEl, { delay: 2000 });
    uploadToastEl.querySelector('#uploadToastMessage').innerText = /*[[${successMessage}]]*/ 'Document uploaded successfully!';
    uploadToast.show();
</script>

<script>
function deleteDoc(id) {
    if(!confirm('Are you sure you want to delete this document?')) return;

    fetch('/documents/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'id=' + id
    })
    .then(res => res.json())
    .then(data => {
        if(data.status === 'success') {
            const row = document.querySelector('tr[data-id="'+id+'"]');
            if(row) row.remove();
            const card = document.querySelector('.doc-card[data-id="'+id+'"]');
            if(card) card.remove();

            const toastEl = document.getElementById('deleteToast');
            toastEl.querySelector('#deleteToastMessage').innerText = data.message;
            const toast = new bootstrap.Toast(toastEl, { delay: 2000 });
            toast.show();
        } else {
            alert(data.message);
        }
    })
    .catch(err => { console.error(err); alert('Something went wrong!'); });
}
</script>

</body>
</html>
